#!/bin/bash

VERSION="1.1.1"
EXPECTED="/usr/local/bin/lamp-manager"
REPO_RAW="https://raw.githubusercontent.com/yuw1xx/lamp/main/scripts/lamp-manager"
REAL_PATH=$(readlink -f "$0")

if [[ "$REAL_PATH" != "$EXPECTED" ]]; then
    echo -e "\033[0;31mâŒ Error: Illegal Execution Path.\033[0m"
    echo "This script must be installed via the official installer to function."
    echo "Use: curl -sSL https://raw.githubusercontent.com/yuw1xx/lamp/main/scripts/install.sh | bash"
    exit 1
fi

update_manager() {
    clear
    echo -e "\033[0;36mğŸ”„ Checking for updates...\033[0m"
    
    REMOTE_CONTENT=$(curl -sSL -m 10 -H "Cache-Control: no-cache" "$REPO_RAW")
    
    if [[ -z "$REMOTE_CONTENT" ]]; then
        echo -e "\033[0;31mâŒ Could not reach GitHub or the file is empty.\033[0m"
    else
        REMOTE_VER=$(echo "$REMOTE_CONTENT" | grep -m1 'VERSION=' | cut -d'"' -f2)
        
        if [[ -z "$REMOTE_VER" ]]; then
            echo -e "\033[0;31mâŒ Failed to parse version from GitHub.\033[0m"
        elif [[ "$REMOTE_VER" == "$VERSION" ]]; then
            echo -e "\033[0;32mâœ… You are on the latest version ($VERSION).\033[0m"
        else
            echo -e "\033[1;33mğŸš€ New version found: $REMOTE_VER (Current: $VERSION)\033[0m"
            read -p "Do you want to update now? (y/N): " choice
            if [[ "$choice" =~ ^[Yy]$ ]]; then
                echo "ğŸ“¥ Downloading update..."
                if sudo curl -sSL "$REPO_RAW" -o "${EXPECTED}.tmp"; then
                    sudo mv "${EXPECTED}.tmp" "$EXPECTED"
                    sudo chmod +x "$EXPECTED"
                    echo -e "\033[0;32mâœ¨ Update complete! Please restart the manager.\033[0m"
                    exit 0
                else
                    echo -e "\033[0;31mâŒ Download failed. Update aborted.\033[0m"
                fi
            fi
        fi
    fi
    read -p "Press Enter to return to menu..."
}

get_services() {
    local svcs=()
    local apache=$(systemctl list-unit-files --type=service | grep -E '^(apache2|httpd)\.service' | awk '{print $1}' | head -n 1)
    local mysql=$(systemctl list-unit-files --type=service | grep -E '^(mariadb|mysql)\.service' | awk '{print $1}' | head -n 1)
    local php=$(systemctl list-unit-files --type=service | grep -E '^php.*-fpm\.service' | awk '{print $1}' | head -n 1)

    [[ -n "$apache" ]] && svcs+=("$apache")
    [[ -n "$mysql" ]] && svcs+=("$mysql")
    [[ -n "$php" ]] && svcs+=("$php")
    echo "${svcs[@]}"
}

SERVICES=($(get_services))

CYAN="\033[0;36m"
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
BOLD="\033[1m"
NC="\033[0m"

service_status() {
    local svc=$1
    local status=$(systemctl is-active "$svc")
    if [[ "$status" == "active" ]]; then
        echo -e "${GREEN}â— RUNNING${NC}"
    else
        echo -e "${RED}â—‹ STOPPED${NC}"
    fi
}

manage() {
    local svc=$1
    local action=$2
    echo -e "${CYAN}ğŸš€ $action-ing $svc...${NC}"
    sudo systemctl "$action" "$svc"
    sleep 1
}

main_menu() {
    while true; do
        clear
        echo -e "${BOLD}${CYAN} ğŸ› ï¸  LAMP MANAGER : UNIVERSAL (v$VERSION)${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

        local i=1
        for s in "${SERVICES[@]}"; do
            echo -ne "${BOLD}$i)${NC} $(printf '%-20s' "$s") "
            service_status "$s"
            ((i++))
        done

        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${BOLD}u)${NC} Check for Updates"
        echo -e "${BOLD}q)${NC} Quit"
        echo ""
        read -p "Select an option: " choice

        if [[ "$choice" == "q" ]]; then
            exit 0
        elif [[ "$choice" == "u" ]]; then
            update_manager
        elif [[ "$choice" -ge 1 && "$choice" -le ${#SERVICES[@]} ]]; then
            service_actions "${SERVICES[$((choice-1))]}"
        fi
    done
}

service_actions() {
    local svc=$1
    while true; do
        clear
        echo -e "${BOLD}${CYAN} ğŸ”§ MANAGE: $svc${NC}"
        echo -e " Current Status: $(service_status "$svc")"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e " 1) ${GREEN}Start${NC}"
        echo -e " 2) ${RED}Stop${NC}"
        echo -e " 3) ${YELLOW}Restart${NC}"
        echo -e " 4) ğŸ” Detailed Status"
        echo -e " 5) ğŸ“ Edit Config"
        echo -e " 6) â¬…ï¸  Back"
        echo ""
        read -p "Select action: " act

        case $act in
            1) manage "$svc" "start" ;;
            2) manage "$svc" "stop" ;;
            3) manage "$svc" "restart" ;;
            4) clear; systemctl status "$svc"; read -p "Press Enter...";;
            5)
               local path=""
               [[ "$svc" =~ (apache|httpd) ]] && path="/etc/apache2/apache2.conf"
               [[ ! -f "$path" && "$svc" =~ (apache|httpd) ]] && path="/etc/httpd/conf/httpd.conf"
               [[ "$svc" =~ (mysql|mariadb) ]] && path="/etc/my.cnf"
               [[ ! -f "$path" && "$svc" =~ (mysql|mariadb) ]] && path="/etc/mysql/my.cnf"
               [[ "$svc" =~ fpm ]] && path=$(php --ini | grep "Loaded Configuration File" | awk '{print $4}')

               if [[ -f "$path" ]]; then sudo ${EDITOR:-nano} "$path"; else echo "Config not found!"; sleep 1; fi
               ;;
            6) return ;;
        esac
    done
}

main_menu
