#!/bin/bash

VERSION="1.0.4"
EXPECTED="/usr/local/bin/lamp-manager"
REPO_RAW="https://raw.githubusercontent.com/yuw1xx/lamp/main/scripts/lamp-manager"
REAL_PATH=$(readlink -f "$0")

if [[ "$REAL_PATH" != "$EXPECTED" ]]; then
    echo -e "\033[0;31m‚ùå Error: Illegal Execution Path.\033[0m"
    echo "This script must be installed via the official installer to function."
    echo "Use: curl -sSL https://raw.githubusercontent.com/yuw1xx/lamp/main/scripts/install.sh | bash"
    exit 1
fi

update_manager() {
    clear
    echo -e "\033[0;36müîÑ Checking for updates...\033[0m"
    
    REMOTE_CONTENT=$(curl -sSL -m 10 -H "Cache-Control: no-cache" "$REPO_RAW")
    
    if [[ -z "$REMOTE_CONTENT" ]]; then
        echo -e "\033[0;31m‚ùå Could not reach GitHub or the file is empty.\033[0m"
    else
        REMOTE_VER=$(echo "$REMOTE_CONTENT" | grep -m1 'VERSION=' | cut -d'"' -f2)
        
        if [[ -z "$REMOTE_VER" ]]; then
            echo -e "\033[0;31m‚ùå Failed to parse version from GitHub.\033[0m"
        elif [[ "$REMOTE_VER" == "$VERSION" ]]; then
            echo -e "\033[0;32m‚úÖ You are on the latest version ($VERSION).\033[0m"
        else
            echo -e "\033[1;33müöÄ New version found: $REMOTE_VER (Current: $VERSION)\033[0m"
            read -p "Do you want to update now? (y/N): " choice
            if [[ "$choice" =~ ^[Yy]$ ]]; then
                echo "üì• Downloading update..."
                if sudo curl -sSL "$REPO_RAW" -o "${EXPECTED}.tmp"; then
                    sudo mv "${EXPECTED}.tmp" "$EXPECTED"
                    sudo chmod +x "$EXPECTED"
                    echo -e "\033[0;32m‚ú® Update complete! Please restart the manager.\033[0m"
                    exit 0
                else
                    echo -e "\033[0;31m‚ùå Download failed. Update aborted.\033[0m"
                fi
            fi
        fi
    fi
    read -p "Press Enter to return to menu..."
}

open_web_interface() {
    echo -e "${CYAN}üåê Opening Web Interface (http://localhost)...${NC}"
    if command -v xdg-open &>/dev/null; then
        xdg-open "http://localhost"
    elif command -v open &>/dev/null; then
        open "http://localhost"
    else
        echo -e "${RED}‚ùå Could not find a browser opener (xdg-open/open).${NC}"
        echo "Please visit http://localhost manually."
        sleep 2
    fi
}

security_scan() {
    clear
    echo -e "${BOLD}${RED}üõ°Ô∏è LAMP SECURITY SCAN${NC}"
    echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

    echo -e "${YELLOW}[!] Checking Open Ports...${NC}"
    if command -v ss &>/dev/null; then
        ss -tuln | grep -E ':80|:443|:3306' | sed 's/^/  /'
    else
        echo "  (ss command not found, skipping port check)"
    fi

    echo -ne "\n${YELLOW}[!] MariaDB Root Access: ${NC}"
    if sudo mysql -u root -e "exit" 2>/dev/null; then
        echo -e "${RED}UNSECURED (No Password)${NC}"
        echo "  Recommendation: Run 'sudo mariadb-secure-installation'"
    else
        echo -e "${GREEN}SECURED (Password Required)${NC}"
    fi

    echo -ne "\n${YELLOW}[!] Web Root Permissions (/var/www/html): ${NC}"
    if [ -d "/var/www/html" ]; then
        perms=$(stat -c "%a" /var/www/html)
        owner=$(stat -c "%U:%G" /var/www/html)
        echo -e "$perms ($owner)"
        [[ "$perms" == "777" ]] && echo -e "  ${RED}‚ö†Ô∏è WARNING: Permissions are too open (777)!${NC}"
    else
        echo "Folder not found."
    fi

    echo -e "\n${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    read -p "Press Enter to return to menu..."
}

get_services() {
    local svcs=()
    local apache=$(systemctl list-unit-files --type=service | grep -E '^(apache2|httpd)\.service' | awk '{print $1}' | head -n 1)
    local mysql=$(systemctl list-unit-files --type=service | grep -E '^(mariadb|mysql)\.service' | awk '{print $1}' | head -n 1)
    local php=$(systemctl list-unit-files --type=service | grep -E '^php.*-fpm\.service' | awk '{print $1}' | head -n 1)

    [[ -n "$apache" ]] && svcs+=("$apache")
    [[ -n "$mysql" ]] && svcs+=("$mysql")
    [[ -n "$php" ]] && svcs+=("$php")
    echo "${svcs[@]}"
}

SERVICES=($(get_services))

CYAN="\033[0;36m"; GREEN="\033[0;32m"; RED="\033[0;31m"; YELLOW="\033[1;33m"; BOLD="\033[1m"; NC="\033[0m"

service_status() {
    local svc=$1
    local status=$(systemctl is-active "$svc")
    if [[ "$status" == "active" ]]; then
        echo -e "${GREEN}‚óè RUNNING${NC}"
    else
        echo -e "${RED}‚óã STOPPED${NC}"
    fi
}

manage() {
    local svc=$1
    local action=$2
    echo -e "${CYAN}üöÄ $action-ing $svc...${NC}"
    sudo systemctl "$action" "$svc"
    sleep 1
}

main_menu() {
    while true; do
        clear
        echo -e "${BOLD}${CYAN} üõ†Ô∏è  LAMP MANAGER : UNIVERSAL (v$VERSION)${NC}"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"

        local i=1
        for s in "${SERVICES[@]}"; do
            echo -ne "${BOLD}$i)${NC} $(printf '%-20s' "$s") "
            service_status "$s"
            ((i++))
        done

        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${BOLD}w)${NC} Web Interface"
        echo -e "${BOLD}s)${NC} Security Scan"
        echo -e "${BOLD}u)${NC} Update"
        echo -e "${BOLD}q)${NC} Quit"
        echo ""
        read -p "Select an option: " choice

        if [[ "$choice" == "q" ]]; then
            exit 0
        elif [[ "$choice" == "w" ]]; then
            open_web_interface
        elif [[ "$choice" == "s" ]]; then
            security_scan
        elif [[ "$choice" == "u" ]]; then
            update_manager
        elif [[ "$choice" -ge 1 && "$choice" -le ${#SERVICES[@]} ]]; then
            service_actions "${SERVICES[$((choice-1))]}"
        fi
    done
}

service_actions() {
    local svc=$1
    while true; do
        clear
        echo -e "${BOLD}${CYAN} üîß MANAGE: $svc${NC}"
        echo -e " Current Status: $(service_status "$svc")"
        echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e " 1) ${GREEN}Start${NC}"
        echo -e " 2) ${RED}Stop${NC}"
        echo -e " 3) ${YELLOW}Restart${NC}"
        echo -e " 4) üîç Status"
        echo -e " 5) üìù Config"
        echo -e " 6) ‚¨ÖÔ∏è  Back"
        echo -e " 7) üìú Live Log Monitor (Ctrl+C to stop)"
        echo ""
        read -p "Select action: " act

        case $act in
            1) manage "$svc" "start" ;;
            2) manage "$svc" "stop" ;;
            3) manage "$svc" "restart" ;;
            4) clear; systemctl status "$svc" --no-pager; echo ""; read -p "Press Enter to return to menu...";;
            5)
               local path=""
               [[ "$svc" =~ (apache|httpd) ]] && path="/etc/apache2/apache2.conf"
               [[ ! -f "$path" && "$svc" =~ (apache|httpd) ]] && path="/etc/httpd/conf/httpd.conf"
               [[ "$svc" =~ (mysql|mariadb) ]] && path="/etc/my.cnf"
               [[ ! -f "$path" && "$svc" =~ (mysql|mariadb) ]] && path="/etc/mysql/my.cnf"
               [[ "$svc" =~ fpm ]] && path=$(php --ini | grep "Loaded Configuration File" | awk '{print $4}')

               if [[ -f "$path" ]]; then sudo ${EDITOR:-nano} "$path"; else echo "Config not found!"; sleep 1; fi
               ;;
            6) return ;;
            7) 
               clear
               echo -e "${YELLOW}üëÄ Monitoring $svc logs... (Press Ctrl+C to stop)${NC}"
               echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
               local log_files=""
               if [[ "$svc" =~ (apache|httpd) ]]; then
                   log_files="/var/log/apache2/*.log /var/log/httpd/*.log"
               elif [[ "$svc" =~ (mysql|mariadb) ]]; then
                   log_files="/var/log/mysql/*.log /var/log/mariadb/*.log /var/lib/mysql/*.err"
               elif [[ "$svc" =~ fpm ]]; then
                   log_files="/var/log/php*-fpm.log"
               fi

               if [[ -n "$log_files" ]] && ls $log_files >/dev/null 2>&1; then
                   sudo tail -f $log_files
               else
                   echo -e "${RED}‚ö†Ô∏è No specific log files found. Falling back to Systemd Journal...${NC}"
                   echo ""
                   sudo journalctl -u "$svc" -f
               fi
               ;;
        esac
    done
}

main_menu
