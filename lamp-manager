#!/bin/bash

# --- 1. Robust Service Discovery ---
# We query systemd specifically for active or loaded units to avoid ghost services
HTTPD_SVC=$(systemctl list-units --type=service --all | grep -E 'apache2|httpd' | awk '{print $1}' | head -n 1)
DB_SVC=$(systemctl list-units --type=service --all | grep -E 'mariadb|mysql' | awk '{print $1}' | head -n 1)
FPM_SVC=$(systemctl list-units --type=service --all | grep -E 'php.*-fpm' | awk '{print $1}' | head -n 1)

SERVICES=()
[[ -n "$HTTPD_SVC" ]] && SERVICES+=("$HTTPD_SVC")
[[ -n "$DB_SVC" ]] && SERVICES+=("$DB_SVC")
[[ -n "$FPM_SVC" ]] && SERVICES+=("$FPM_SVC")

# --- 2. UI & Colors ---
CYAN="\033[0;36m"
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
BOLD="\033[1m"
NC="\033[0m"

show_logo() {
    clear
    echo -e "${CYAN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "             LAMP MANAGER: UNIVERSAL             "
    echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# --- 3. Core Logic ---
manage_service() {
    local svc=$1
    local action=$2
    echo -e "${YELLOW}âš™ï¸  Executing $action on $svc...${NC}"
    sudo systemctl "$action" "$svc"
    
    if [[ "$action" == "status" ]]; then
        echo -e "\n${BOLD}Current Status:${NC}"
        systemctl status "$svc" --no-pager | grep -E "Active:"
        echo ""
        read -n 1 -s -r -p "Press any key to return..."
    else
        sleep 1
    fi
}

edit_config() {
    local svc=$1
    # Dynamic config discovery
    local path=""
    case "$svc" in
        *apache2*|*httpd*) [[ -f "/etc/apache2/apache2.conf" ]] && path="/etc/apache2/apache2.conf" || path="/etc/httpd/conf/httpd.conf" ;;
        *mariadb*|*mysql*) [[ -f "/etc/mysql/my.cnf" ]] && path="/etc/mysql/my.cnf" || path="/etc/my.cnf" ;;
        *fpm*) path=$(php --ini | grep "Loaded Configuration File" | awk '{print $4}') ;;
    esac

    if [[ -f "$path" ]]; then
        sudo ${EDITOR:-nano} "$path"
    else
        echo -e "${RED}âŒ Configuration file not found for $svc${NC}"
        read -n 1 -s -r -p "Press any key to return..."
    fi
}

# --- 4. Menus ---
service_menu() {
    local svc=$1
    while true; do
        show_logo
        echo -e "Selected Service: ${GREEN}${BOLD}$svc${NC}\n"
        
        # Using a simple list for the sub-menu to keep it stable
        echo -e "1) ${GREEN}â–¶ Start${NC}"
        echo -e "2) ${RED}â–  Stop${NC}"
        echo -e "3) ${YELLOW}â†» Restart${NC}"
        echo -e "4) ðŸ” Status"
        echo -e "5) ðŸ“ Edit Config"
        echo -e "6) â¬… Back"
        echo ""
        read -p "Choose an option [1-6]: " opt

        case $opt in
            1) manage_service "$svc" "start" ;;
            2) manage_service "$svc" "stop" ;;
            3) manage_service "$svc" "restart" ;;
            4) manage_service "$svc" "status" ;;
            5) edit_config "$svc" ;;
            6) return ;;
            *) echo -e "${RED}Invalid option${NC}"; sleep 1 ;;
        esac
    done
}

# --- 5. Main Loop ---
while true; do
    show_logo
    echo -e "Select a service to manage:\n"

    # Fixed fzf logic: No more "ExitExit"
    if command -v fzf &>/dev/null; then
        # Create a clean list for fzf
        choice=$(printf "%s\n" "${SERVICES[@]}" "QUIT" | fzf \
            --height 10% \
            --layout=reverse \
            --border \
            --inline-info \
            --header="Use arrows to select, Enter to confirm")
    else
        # Fallback to standard select if fzf is missing
        select choice in "${SERVICES[@]}" "QUIT"; do break; done
    fi

    if [[ "$choice" == "QUIT" || -z "$choice" ]]; then
        echo -e "${CYAN}Goodbye!${NC}"
        exit 0
    fi

    service_menu "$choice"
done
